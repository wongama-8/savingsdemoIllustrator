<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savings + Protection Illustrator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons for benefits section -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Light Gray/Off-white background */
            color: #1e293b; /* Dark Slate text */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #e2e8f0;
        }
        .section-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #1e293b; /* text-slate-800 */
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #2563eb; /* Corporate Blue underline */
            display: inline-block;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-color: #2563eb; /* Corporate Blue */
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #1d4ed8; /* Darker Blue */
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #475569;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
        .table-header {
            background-color: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }
        .table-row-hover:hover {
            background-color: #f8fafc;
            cursor: pointer;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: #ffffff;
            color: #1e293b;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 400px;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            color: #475569;
        }
        .tab-button.active {
            color: #2563eb; /* Corporate Blue for active tab */
            border-bottom-color: #2563eb;
        }
        /* Custom slider styles */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            margin-top: -8px; 
        }
        input[type=range]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 5px;
        }
        .summary-box {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }
        .summary-box-label {
            font-size: 0.875rem; /* text-sm */
            color: #64748b; /* text-slate-500 */
        }
        .summary-box-value {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #1e293b; /* text-slate-800 */
        }
        .highlighted-blue {
            background-color: #eff6ff; /* Blue 50 */
            border: 1px solid #bfdbfe; /* Blue 300 */
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .highlighted-green {
            background-color: #f0fdf4; /* Green 50 */
            border: 1px solid #86efac; /* Green 300 */
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .benefit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .milestone-point:hover {
            cursor: pointer;
            transform: scale(1.2);
            transition: transform 0.2s ease-in-out;
        }
        /* New styles for responsive buttons */
        @media (max-width: 1023px) {
            .input-buttons {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto space-y-8">
        <h1 class="text-4xl font-bold text-center text-slate-800">Savings + Protection Illustrator</h1>

        <!-- Inputs -->
        <div class="card">
            <h2 class="section-title">Client & Product Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Goal Selector -->
                <div class="lg:col-span-4">
                    <label for="savingsGoal" class="block text-sm font-medium text-slate-600">Primary Savings Goal</label>
                    <select id="savingsGoal" class="w-full mt-1 p-2 bg-slate-50 border border-slate-300 rounded-md">
                        <option value="education">Education Fund (for a child)</option>
                        <option value="retirement">Retirement Plan (for self)</option>
                        <option value="legacy">Legacy</option>
                    </select>
                </div>

                <!-- Age Inputs -->
                <div id="ageInputs" class="lg:col-span-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div>
                        <label for="clientAge" class="block text-sm font-medium text-slate-600">Client's Current Age</label>
                        <input type="number" id="clientAge" class="w-full mt-1 p-2 bg-slate-50 border border-slate-300 rounded-md">
                    </div>
                    <div id="parentAgeWrapper" class="hidden">
                         <label for="parentAge" class="block text-sm font-medium text-slate-600">Parent's Current Age</label>
                         <input type="number" id="parentAge" class="w-full mt-1 p-2 bg-slate-50 border border-slate-300 rounded-md">
                    </div>
                </div>


                <!-- Financial Inputs -->
                <div>
                    <label for="annualPremium" class="block text-sm font-medium text-slate-600">Annual Saving (RM)</label>
                    <input type="number" id="annualPremium" class="w-full mt-1 p-2 bg-slate-50 border border-slate-300 rounded-md">
                </div>
                <div>
                    <label for="paymentTerm" class="block text-sm font-medium text-slate-600">Saving Term (years)</label>
                    <input type="number" id="paymentTerm" class="w-full mt-1 p-2 bg-slate-50 border border-slate-300 rounded-md" value="10">
                </div>
                <div>
                    <label for="annualGuaranteedPayout" class="block text-sm font-medium text-slate-600">Annual Payout (RM)</label>
                    <input type="number" id="annualGuaranteedPayout" class="w-full mt-1 p-2 bg-slate-50 border border-slate-300 rounded-md">
                </div>
                <div>
                    <label for="policyPeriod" class="block text-sm font-medium text-slate-600">Total Policy Period (years)</label>
                    <input type="number" id="policyPeriod" class="w-full mt-1 p-2 bg-slate-50 border border-slate-300 rounded-md" value="20">
                </div>
                <div>
                    <label for="interestRate" class="block text-sm font-medium text-slate-600">Interest Rate (%)</label>
                    <input type="number" id="interestRate" class="w-full mt-1 p-2 bg-slate-50 border border-slate-300 rounded-md" value="4.8">
                </div>
                <div>
                    <label for="maturityValue" class="block text-sm font-medium text-slate-600">Guaranteed Maturity Payout (b)</label>
                    <input type="number" id="maturityValue" class="w-full mt-1 p-2 bg-slate-50 border border-slate-300 rounded-md">
                </div>
                <div>
                    <label for="nonGuaranteedValue" class="block text-sm font-medium text-slate-600">Non-Guaranteed Cash Value (c)</label>
                    <input type="number" id="nonGuaranteedValue" class="w-full mt-1 p-2 bg-slate-50 border border-slate-300 rounded-md">
                </div>
                
                 <!-- Protection Inputs -->
                <div>
                    <label for="deathPayoutEarly" class="block text-sm font-medium text-slate-600">Sum Assured (Yrs 1-5)</label>
                    <input type="number" id="deathPayoutEarly" class="w-full mt-1 p-2 bg-slate-50 border border-slate-300 rounded-md">
                </div>
                 <div>
                    <label for="deathPayoutLate" class="block text-sm font-medium text-slate-600">Sum Assured (Yrs 6+)</label>
                    <input type="number" id="deathPayoutLate" class="w-full mt-1 p-2 bg-slate-50 border border-slate-300 rounded-md">
                </div>
                 <div class="flex items-end justify-start">
                    <div class="flex items-center">
                        <input id="juvenilePolicy" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="juvenilePolicy" class="ml-2 block text-sm text-slate-600">This is a Juvenile Policy</label>
                    </div>
                </div>
            </div>
            
             <!-- Separated Save/Load/Calculate buttons for better hierarchy -->
             <div class="mt-8 flex items-end justify-end space-x-2">
                 <button id="saveBtn" class="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">Save</button>
                 <button id="loadBtn" class="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">Load</button>
                 <button id="calculateBtn" class="btn-primary">Calculate</button>
             </div>
        </div>
        
        <!-- Consolidated Summary & Protection -->
        <div id="summaryCard" class="card">
            <h2 class="section-title">Overall Summary</h2>

            <!-- New: Dynamic Goal Statement -->
            <div id="goalStatement" class="text-center bg-gray-50 border border-gray-200 rounded-lg p-4 mb-8">
                <p class="text-sm font-medium text-slate-600 mb-1">Your savings goal:</p>
                <p class="text-2xl font-bold text-slate-800">Please enter values and click "Calculate"</p>
            </div>
            
            <!-- New: Summary boxes for key metrics -->
            <div id="clientSummary" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                <div class="summary-box">
                    <p class="summary-box-label">Annual Saving</p>
                    <p class="summary-box-value">RM 0</p>
                </div>
                <div class="summary-box">
                    <p class="summary-box-label">Saving Term (years)</p>
                    <p class="summary-box-value">0</p>
                </div>
                <div class="summary-box">
                    <p class="summary-box-label">Total Saving</p>
                    <p class="summary-box-value">RM 0</p>
                </div>
                <div class="summary-box">
                    <p class="summary-box-label">Coverage Period</p>
                    <p class="summary-box-value">0</p>
                </div>
                <div class="summary-box col-span-2">
                     <p class="summary-box-label">Death / TPD Payout (Yr 1-5)</p>
                     <p class="summary-box-value">RM 0</p>
                </div>
            </div>
            
            <!-- New: Benefits Section with Icons -->
            <div id="benefitsSection" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-12">
                 <div class="flex flex-col items-center text-center p-4 rounded-lg bg-white shadow-sm transition-transform duration-200 hover:scale-105 benefit-card">
                     <div class="h-12 w-12 flex items-center justify-center bg-blue-500 rounded-full text-white mb-2">
                        <i data-lucide="wallet" class="w-6 h-6"></i>
                    </div>
                    <p class="font-semibold text-slate-800 text-sm mb-1">Guaranteed Payouts</p>
                    <p class="text-xs text-slate-500">Receive annual guaranteed payouts from Year 1 to maturity.</p>
                </div>
                <div class="flex flex-col items-center text-center p-4 rounded-lg bg-white shadow-sm transition-transform duration-200 hover:scale-105 benefit-card">
                     <div class="h-12 w-12 flex items-center justify-center bg-blue-500 rounded-full text-white mb-2">
                        <i data-lucide="shield-check" class="w-6 h-6"></i>
                    </div>
                    <p class="font-semibold text-slate-800 text-sm mb-1">Financial Safety Net</p>
                    <p class="text-xs text-slate-500">Combines savings and protection for a secure financial future.</p>
                </div>
                <div class="flex flex-col items-center text-center p-4 rounded-lg bg-white shadow-sm transition-transform duration-200 hover:scale-105 benefit-card">
                     <div class="h-12 w-12 flex items-center justify-center bg-blue-500 rounded-full text-white mb-2">
                        <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                    </div>
                    <p class="font-semibold text-slate-800 text-sm mb-1">Short Saving Term</p>
                    <p class="text-xs text-slate-500">Save for only ${paymentTerm} years to enjoy a total policy period of ${policyPeriod} years.</p>
                </div>
                <div class="flex flex-col items-center text-center p-4 rounded-lg bg-white shadow-sm transition-transform duration-200 hover:scale-105 benefit-card">
                     <div class="h-12 w-12 flex items-center justify-center bg-blue-500 rounded-full text-white mb-2">
                        <i data-lucide="heart-pulse" class="w-6 h-6"></i>
                    </div>
                    <p class="font-semibold text-slate-800 text-sm mb-1">Waiver Benefits</p>
                    <p class="text-xs text-slate-500">Future savings are waived in case of TPD or critical illness.</p>
                </div>
            </div>

            <!-- Visual Timeline -->
            <div id="timelineContainer" class="mb-24 pt-4">
                <p class="text-lg font-semibold text-slate-700 text-center mb-4">Key Milestones</p>
                <div class="relative w-3/4 mx-auto h-2 bg-slate-200 rounded-full">
                    <div id="paymentProgressBar" class="absolute h-2 bg-blue-500 rounded-full"></div>
                    <div id="startMilestone" class="milestone-point absolute top-1/2 -translate-y-1/2 -translate-x-1/2">
                        <div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow"></div>
                        <div id="startLabel" class="absolute top-6 left-1/2 -translate-x-1/2 text-center text-xs w-24">Age 0<br>Start</div>
                    </div>
                    <div id="paymentEndMilestone" class="milestone-point absolute top-1/2 -translate-y-1/2 -translate-x-1/2">
                        <div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow"></div>
                        <div id="paymentEndLabel" class="absolute top-6 left-1/2 -translate-x-1/2 text-center text-xs w-24">Age 10<br>Saving Term Ends</div>
                    </div>
                    <div id="maturityMilestone" class="milestone-point absolute top-1/2 -translate-y-1/2 -translate-x-1/2" style="right: 0;">
                        <div class="w-4 h-4 bg-green-500 rounded-full border-2 border-white shadow"></div>
                        <div id="maturityLabel" class="absolute top-6 left-1/2 -translate-x-1/2 text-center text-xs w-24">Age 20<br>Maturity</div>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-x-8 gap-y-6">
                <!-- Column 1: Guaranteed -->
                <div class="flex flex-col space-y-4 p-6 rounded-lg border border-blue-300 bg-blue-50">
                    <h3 class="text-lg font-semibold text-blue-800">Guaranteed Returns at Maturity</h3>
                    <div class="flex-grow space-y-2">
                        <div class="flex justify-between items-baseline">
                            <p class="text-sm text-blue-700">Accumulated Payouts (a)</p>
                            <p id="totalAccumulatedGuaranteedPayout" class="text-xl font-semibold text-blue-800">RM 0</p>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <p class="text-sm text-blue-700">Maturity Payout (b)</p>
                            <p id="guaranteedMaturity" class="text-xl font-semibold text-blue-800">RM 0</p>
                        </div>
                    </div>
                    <div class="text-blue-800 pt-4 border-t border-blue-200 highlighted-blue">
                        <p class="text-md font-medium">Total Guaranteed Payout (a+b)</p>
                        <p id="totalGuaranteedPayout" class="text-4xl font-bold">RM 0</p>
                    </div>
                </div>
                <!-- Column 2: Potential Equation -->
                <div class="flex flex-col space-y-4 p-6 rounded-lg border border-green-300 bg-green-50">
                     <h3 class="text-lg font-semibold text-green-800">Projected Returns at Maturity</h3>
                     <div class="flex-grow space-y-2">
                        <div class="flex justify-between items-baseline">
                            <p class="text-sm text-slate-500">Total Guaranteed Payout (a+b)</p>
                            <p id="guaranteedForEquation" class="text-xl font-semibold text-slate-700">RM 0</p>
                        </div>
                         <div class="flex justify-between items-baseline">
                            <p class="text-sm text-green-700">+ Non-Guaranteed Cash Value (c)</p>
                            <p id="cashValue" class="text-xl font-semibold text-green-800">RM 0</p>
                        </div>
                    </div>
                     <div class="text-green-800 pt-4 border-t border-green-200 highlighted-green">
                        <p class="text-md font-medium">Total Projected Payout (a+b+c)</p>
                        <p id="totalProjectedPayout" class="text-4xl font-bold">RM 0</p>
                    </div>
                </div>
            </div>
            <!-- Bottom Section: Net Result -->
            <div class="mt-6 pt-6 border-t border-slate-200 grid md:grid-cols-2 gap-8">
                <div>
                    <p id="totalPremiumsLabel" class="text-sm text-slate-500">Total Savings</p>
                    <p id="totalPremiums" class="text-3xl font-semibold text-slate-700">RM 0</p>
                </div>
                <div class="text-green-600">
                    <p class="text-sm">Projected Growth</p>
                    <p id="totalGrowth" class="text-3xl font-bold">RM 0</p>
                </div>
            </div>
        </div>

        <!-- Details with Tabs -->
        <div id="detailsSection" class="card">
            <div class="border-b border-slate-200 mb-4">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="tabTable" class="tab-button active">Payout Table</button>
                    <button id="tabChart" class="tab-button">Growth Chart</button>
                    <button id="tabProtection" class="tab-button">Protection Details</button>
                    <button id="tabReport" class="tab-button print-only">Print</button>
                </nav>
            </div>
            
            <!-- Tab Content -->
            <div>
                <div id="tableContent">
                    <p class="text-sm text-slate-500 mb-4">Tap a row to edit the guaranteed payout for that year.</p>
                    <div class="flex justify-center">
                        <table class="w-full text-left">
                            <thead class="table-header sticky top-0">
                                <tr>
                                    <th class="p-3 font-semibold text-center w-1/12">Year</th>
                                    <th class="p-3 font-semibold text-right w-2/12">Annual Saving</th>
                                    <th class="p-3 font-semibold text-right w-1/12">%</th>
                                    <th class="p-3 font-semibold text-right w-3/12">Annual Payout/ Saving</th>
                                    <th class="p-3 text-right font-semibold w-5/12">Total Saving + Interest (<span id="interestRateHeader">0.0</span>% p.a.)</th>
                                </tr>
                            </thead>
                            <tbody id="savingsTableBody">
                                <tr><td colspan="5" class="text-center p-4 text-slate-500">Please enter values and click "Calculate" to see the table.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="chartContent" class="hidden">
                    <div class="h-96">
                         <canvas id="growthChart"></canvas>
                    </div>
                </div>
                <!-- Protection Details Tab Content -->
                <div id="protectionContent" class="hidden">
                    <div class="pt-6">
                        <h3 id="protectionTitle" class="text-xl font-semibold text-slate-800 mb-4">How Your Goal is Protected</h3>
                        <div class="grid md:grid-cols-2 gap-8 items-center">
                            <div>
                                <label for="protectionYearSlider" class="block text-sm font-medium text-slate-600 mb-2">Select a year to see the protection value:</label>
                                <input type="range" id="protectionYearSlider" min="1" max="20" value="7" class="w-full">
                                <div class="text-center text-lg font-semibold mt-2">Year <span id="protectionYearLabel">7</span></div>
                            </div>
                            <div id="protectionNarrative" class="space-y-4 p-6 rounded-lg bg-slate-50 border border-slate-300">
                                <!-- Dynamic content will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-center mt-8">
            <button id="generatePdfBtn" class="btn-secondary hidden">Generate Report (PDF)</button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-backdrop hidden">
        <div class="modal-content text-center">
            <h3 id="modalTitle" class="text-xl font-bold mb-4">Edit Year 1 Guaranteed Payout</h3>
             <div class="mb-4">
                 <label for="modalSavingsInput" class="block text-sm font-medium text-slate-600 text-left">Annual Payout/ Saving (RM)</label>
                 <input type="number" id="modalSavingsInput" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-md text-center text-2xl">
            </div>
            <div class="mb-6">
                <label for="modalPercentageInput" class="block text-sm font-medium text-slate-600 text-left">Percentage (%)</label>
                <input type="number" id="modalPercentageInput" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-md text-center text-2xl" value="3">
            </div>
            <div class="flex items-center justify-center mb-6">
                <input id="applyToFollowing" type="checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
                <label for="applyToFollowing" class="ml-2 block text-sm text-slate-600">Apply to the following years</label>
            </div>
            <div class="flex justify-center space-x-4">
                <button id="cancelBtn" class="py-2 px-8 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">Cancel</button>
                <button id="saveModalBtn" class="py-2 px-10 btn-primary">OK</button>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const calculateBtn = document.getElementById('calculateBtn');
        const saveScenarioBtn = document.getElementById('saveBtn');
        const loadScenarioBtn = document.getElementById('loadBtn');
        const generatePdfBtn = document.getElementById('generatePdfBtn');
        const savingsGoalSelect = document.getElementById('savingsGoal');
        const juvenilePolicyCheckbox = document.getElementById('juvenilePolicy');
        const clientAgeInput = document.getElementById('clientAge');
        const parentAgeInput = document.getElementById('parentAge');
        const ageInputs = document.getElementById('ageInputs');
        const parentAgeWrapper = document.getElementById('parentAgeWrapper');
        const annualPremiumInput = document.getElementById('annualPremium');
        const paymentTermInput = document.getElementById('paymentTerm');
        const annualGuaranteedPayoutInput = document.getElementById('annualGuaranteedPayout');
        const policyPeriodInput = document.getElementById('policyPeriod');
        const interestRateInput = document.getElementById('interestRate');
        const maturityValueInput = document.getElementById('maturityValue');
        const nonGuaranteedValueInput = document.getElementById('nonGuaranteedValue');
        const deathPayoutEarlyInput = document.getElementById('deathPayoutEarly');
        const deathPayoutLateInput = document.getElementById('deathPayoutLate');
        
        const savingsTableBody = document.getElementById('savingsTableBody');
        const summaryCard = document.getElementById('summaryCard');
        const detailsSection = document.getElementById('detailsSection');
        const timelineContainer = document.getElementById('timelineContainer');
        const benefitsSection = document.getElementById('benefitsSection');
        const goalStatementEl = document.getElementById('goalStatement');
        const clientSummaryEl = document.getElementById('clientSummary');
        
        // Summary Card Elements
        const totalProjectedPayoutEl = document.getElementById('totalProjectedPayout');
        const totalGuaranteedPayoutEl = document.getElementById('totalGuaranteedPayout');
        const guaranteedForEquationEl = document.getElementById('guaranteedForEquation');
        const totalPremiumsEl = document.getElementById('totalPremiums');
        const totalPremiumsLabel = document.getElementById('totalPremiumsLabel');
        const totalAccumulatedGuaranteedPayoutEl = document.getElementById('totalAccumulatedGuaranteedPayout');
        const guaranteedMaturityEl = document.getElementById('guaranteedMaturity');
        const cashValueEl = document.getElementById('cashValue');
        const totalGrowthEl = document.getElementById('totalGrowth');
        
        const growthChartCanvas = document.getElementById('growthChart');
        
        // Tab Elements
        const tabChartBtn = document.getElementById('tabChart');
        const tabTableBtn = document.getElementById('tabTable');
        const tabProtectionBtn = document.getElementById('tabProtection');
        const chartContent = document.getElementById('chartContent');
        const tableContent = document.getElementById('tableContent');
        const protectionContent = document.getElementById('protectionContent');

        // Protection Card Elements
        const protectionTitle = document.getElementById('protectionTitle');
        const protectionYearSlider = document.getElementById('protectionYearSlider');
        const protectionYearLabel = document.getElementById('protectionYearLabel');
        const protectionNarrative = document.getElementById('protectionNarrative');
        const interestRateHeader = document.getElementById('interestRateHeader');

        // Modal Elements
        const editModal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalSavingsInput = document.getElementById('modalSavingsInput');
        const modalPercentageInput = document.getElementById('modalPercentageInput');
        const applyToFollowingCheckbox = document.getElementById('applyToFollowing');
        const saveModalBtn = document.getElementById('saveModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        // App state
        let guaranteedPayoutsData = [];
        let percentageData = [];
        let interestRate = 0;
        let policyPeriod = 0;
        let lineChartInstance = null;
        let currentlyEditingYear = -1;
        let finalGuaranteedPayout = 0;
        let finalProjectedPayout = 0;
        
        Chart.register(ChartDataLabels);

        // --- Event Listeners ---
        calculateBtn.addEventListener('click', runInitialCalculation);
        saveScenarioBtn.addEventListener('click', saveScenario);
        loadScenarioBtn.addEventListener('click', loadScenario);
        generatePdfBtn.addEventListener('click', () => window.print());
        saveModalBtn.addEventListener('click', saveChanges);
        cancelBtn.addEventListener('click', closeModal);
        tabChartBtn.addEventListener('click', () => switchTab('chart'));
        tabTableBtn.addEventListener('click', () => switchTab('table'));
        tabProtectionBtn.addEventListener('click', () => switchTab('protection'));
        savingsGoalSelect.addEventListener('change', () => {
            if (savingsGoalSelect.value === 'education') {
                parentAgeWrapper.classList.remove('hidden');
                clientAgeInput.previousElementSibling.textContent = "Child's Current Age";
            } else {
                parentAgeWrapper.classList.add('hidden');
                clientAgeInput.previousElementSibling.textContent = "Client's Current Age";
            }
        });
        protectionYearSlider.addEventListener('input', updateProtectionNarrative);
        window.addEventListener('DOMContentLoaded', () => {
            initializeDefaultValues();
            renderTable([]);
            renderSummary(0,0,0,0,0,0,10,savingsGoalSelect.value,0,0);
            renderBenefitsSection(10,20,'education');
            renderLineChart({
                labels: [],
                projectedPayoutValues: [],
                guaranteedPayoutValues: [],
                totalPremiumValues: [],
                protectionValues: [],
                annualPayoutValues: [],
            });
            updateProtectionNarrative();
            updateTimeline();
        });
        document.getElementById('startMilestone').addEventListener('click', () => {
            switchTab('protection');
            protectionYearSlider.value = 1;
            updateProtectionNarrative();
        });
        document.getElementById('paymentEndMilestone').addEventListener('click', () => {
            switchTab('protection');
            const paymentTerm = parseInt(paymentTermInput.value);
            if (!isNaN(paymentTerm) && paymentTerm > 0) {
                 protectionYearSlider.value = paymentTerm;
                 updateProtectionNarrative();
            }
        });
        document.getElementById('maturityMilestone').addEventListener('click', () => {
            switchTab('protection');
            const policyPeriod = parseInt(policyPeriodInput.value);
            if (!isNaN(policyPeriod) && policyPeriod > 0) {
                protectionYearSlider.value = policyPeriod;
                updateProtectionNarrative();
            }
        });

        // Initialize default empty values for inputs
        function initializeDefaultValues() {
            clientAgeInput.value = '';
            parentAgeInput.value = '';
            annualPremiumInput.value = '';
            annualGuaranteedPayoutInput.value = '';
            maturityValueInput.value = '';
            nonGuaranteedValueInput.value = '';
            deathPayoutEarlyInput.value = '';
            deathPayoutLateInput.value = '';
        }

        function runInitialCalculation() {
            policyPeriod = parseInt(policyPeriodInput.value);
            const initialGuaranteedPayout = parseFloat(annualGuaranteedPayoutInput.value);
            const initialPercentage = parseFloat(modalPercentageInput.value);

            // Added check to ensure valid numeric inputs before proceeding
            if (isNaN(policyPeriod) || isNaN(initialGuaranteedPayout) || isNaN(initialPercentage) || policyPeriod <= 0) {
                const message = 'Please enter valid inputs.';
                showTemporaryMessage(message);
                return;
            }

            guaranteedPayoutsData = Array(policyPeriod).fill(initialGuaranteedPayout);
            percentageData = Array(policyPeriod).fill(initialPercentage);

            
            protectionYearSlider.max = policyPeriod;
            protectionYearSlider.value = Math.min(7, policyPeriod);


            calculateAndRender();
            
            summaryCard.classList.remove('hidden');
            detailsSection.classList.remove('hidden');
            generatePdfBtn.classList.remove('hidden');
            switchTab('table'); // Set initial tab to table
        }

        function calculateAndRender() {
            // All calculation logic is now centralized here
            const goal = savingsGoalSelect.value;
            const isJuvenile = juvenilePolicyCheckbox.checked;
            const annualPremium = parseFloat(annualPremiumInput.value) || 0;
            const paymentTerm = parseInt(paymentTermInput.value) || 0;
            const maturityValue = parseFloat(maturityValueInput.value) || 0;
            const nonGuaranteedValue = parseFloat(nonGuaranteedValueInput.value) || 0;
            interestRate = parseFloat(interestRateInput.value) / 100 || 0;
            policyPeriod = parseInt(policyPeriodInput.value) || 0;
            const deathPayoutEarly = parseFloat(deathPayoutEarlyInput.value) || 0;
            const deathPayoutLate = parseFloat(deathPayoutLateInput.value) || 0;
            const clientAge = parseInt(clientAgeInput.value) || 0;
            const parentAge = parseInt(parentAgeInput.value) || 0;
            
            // Check for valid numeric inputs, which was the source of the TypeError
            if (isNaN(annualPremium) || isNaN(paymentTerm) || isNaN(maturityValue) || isNaN(nonGuaranteedValue) || isNaN(interestRate) || isNaN(policyPeriod) || isNaN(deathPayoutEarly) || isNaN(deathPayoutLate) || isNaN(clientAge) || isNaN(parentAge)) {
                return;
            }


            // Update UI based on Goal
            if (goal === 'education') {
                parentAgeWrapper.classList.remove('hidden');
                clientAgeInput.previousElementSibling.textContent = "Child's Current Age";
                timelineContainer.classList.remove('hidden');
            } else {
                parentAgeWrapper.classList.add('hidden');
                clientAgeInput.previousElementSibling.textContent = "Client's Current Age";
                timelineContainer.classList.remove('hidden');
            }


            let accumulatedPayoutValue = 0;
            const tableRows = [];
            const growthData = {
                labels: [],
                projectedPayoutValues: [],
                guaranteedPayoutValues: [],
                totalPremiumValues: [],
                protectionValues: [],
                annualPayoutValues: [],
            };

            let totalPremiumsPaid = 0;
            const juvenileLien = [0.4, 0.6, 0.8, 1.0, 1.0]; // 40%, 60%, 80%, 100%, 100%
            
            // Added check to make sure arrays are initialized
            if (!guaranteedPayoutsData || guaranteedPayoutsData.length === 0) {
                 guaranteedPayoutsData = Array(policyPeriod).fill(0);
                 percentageData = Array(policyPeriod).fill(0);
            }

            for (let year = 1; year <= policyPeriod; year++) {
                let premiumPaidThisYear = 0;
                if (year <= paymentTerm) {
                    premiumPaidThisYear = annualPremium;
                    totalPremiumsPaid += annualPremium;
                }

                const annualPayout = guaranteedPayoutsData[year - 1];
                
                const interestEarned = accumulatedPayoutValue * interestRate;
                accumulatedPayoutValue += interestEarned + annualPayout;

                tableRows.push({
                    year: year,
                    premiumPaidThisYear: premiumPaidThisYear,
                    annualPayout: annualPayout,
                    percentage: percentageData[year-1],
                    total: accumulatedPayoutValue
                });
                
                let guaranteedPayoutForChart = accumulatedPayoutValue;
                let projectedPayoutForChart = accumulatedPayoutValue;

                if (year === policyPeriod) {
                    guaranteedPayoutForChart += maturityValue;
                    projectedPayoutForChart += maturityValue + nonGuaranteedValue;
                }
                
                let protectionPayout = 0;
                if (year <= 5) {
                    protectionPayout = isJuvenile ? deathPayoutEarly * juvenileLien[year-1] : deathPayoutEarly;
                } else {
                    protectionPayout = deathPayoutLate;
                }

                growthData.labels.push(`Year ${year}`);
                growthData.projectedPayoutValues.push(projectedPayoutForChart);
                growthData.guaranteedPayoutValues.push(guaranteedPayoutForChart);
                growthData.totalPremiumValues.push(totalPremiumsPaid);
                growthData.protectionValues.push(protectionPayout);
                growthData.annualPayoutValues.push(annualPayout);
            }

            finalGuaranteedPayout = accumulatedPayoutValue + maturityValue;
            finalProjectedPayout = finalGuaranteedPayout + nonGuaranteedValue;

            renderTable(tableRows);
            renderSummary(totalPremiumsPaid, finalGuaranteedPayout, finalProjectedPayout, accumulatedPayoutValue, maturityValue, nonGuaranteedValue, paymentTerm, goal, clientAge, parentAge);
            renderBenefitsSection(paymentTerm, policyPeriod, goal);
            renderClientSummary(annualPremium, paymentTerm, totalPremiumsPaid, policyPeriod, deathPayoutEarly, deathPayoutLate);
            renderLineChart(growthData);
            updateProtectionNarrative();
            updateTimeline();
        }

        function saveScenario() {
            const scenario = {
                savingsGoal: savingsGoalSelect.value,
                isJuvenile: juvenilePolicyCheckbox.checked,
                clientAge: clientAgeInput.value,
                parentAge: parentAgeInput.value,
                annualPremium: annualPremiumInput.value,
                paymentTerm: paymentTermInput.value,
                annualGuaranteedPayout: annualGuaranteedPayoutInput.value,
                policyPeriod: policyPeriodInput.value,
                interestRate: interestRateInput.value,
                maturityValue: maturityValueInput.value,
                nonGuaranteedValue: nonGuaranteedValueInput.value,
                deathPayoutEarly: deathPayoutEarlyInput.value,
                deathPayoutLate: deathPayoutLateInput.value,
                guaranteedPayoutsData: guaranteedPayoutsData,
                percentageData: percentageData
            };
            localStorage.setItem('savedScenario', JSON.stringify(scenario));
            // A more elegant alert to the user, using a temporary message box.
            const message = "Scenario saved to local storage!";
            showTemporaryMessage(message);
        }
        
        function loadScenario() {
            const savedScenario = localStorage.getItem('savedScenario');
            if (savedScenario) {
                const scenario = JSON.parse(savedScenario);
                savingsGoalSelect.value = scenario.savingsGoal;
                juvenilePolicyCheckbox.checked = scenario.isJuvenile;
                clientAgeInput.value = scenario.clientAge;
                parentAgeInput.value = scenario.parentAge;
                annualPremiumInput.value = scenario.annualPremium;
                paymentTermInput.value = scenario.paymentTerm;
                annualGuaranteedPayoutInput.value = scenario.annualGuaranteedPayout;
                policyPeriodInput.value = scenario.policyPeriod;
                interestRateInput.value = scenario.interestRate;
                maturityValueInput.value = scenario.maturityValue;
                nonGuaranteedValueInput.value = scenario.nonGuaranteedValue;
                deathPayoutEarlyInput.value = scenario.deathPayoutEarly;
                deathPayoutLateInput.value = scenario.deathPayoutLate;
                guaranteedPayoutsData = scenario.guaranteedPayoutsData;
                percentageData = scenario.percentageData;
                calculateAndRender();
                 const message = "Scenario loaded!";
                 showTemporaryMessage(message);
            } else {
                 const message = "No saved scenario found.";
                 showTemporaryMessage(message);
            }
        }
        
        function renderClientSummary(annualSaving, savingTerm, totalSaving, coveragePeriod, deathPayoutEarly, deathPayoutLate) {
            const isJuvenile = juvenilePolicyCheckbox.checked;
            const juvenileLien = [0.4, 0.6, 0.8, 1.0, 1.0];

            let deathPayouts = [];
            if (isJuvenile) {
                 deathPayouts.push({ label: 'Death / TPD Payout (Yr 5)', value: formatCurrency(deathPayoutEarly * juvenileLien[4]) });
                 deathPayouts.push({ label: `Death / TPD Payout (Yr 6+)`, value: formatCurrency(deathPayoutLate) });
            } else {
                deathPayouts.push({ label: 'Death / TPD Payout (Yr 1-5)', value: formatCurrency(deathPayoutEarly) });
                deathPayouts.push({ label: `Death / TPD Payout (Yr 6+)`, value: formatCurrency(deathPayoutLate) });
            }

             const clientSummary = [
                { label: 'Annual Saving', value: formatCurrency(annualSaving) },
                { label: 'Saving Term (years)', value: savingTerm + '' },
                { label: 'Total Saving', value: formatCurrency(totalSaving) },
                { label: 'Coverage Period', value: coveragePeriod + '' },
            ];

            const primarySummaryHTML = clientSummary.map(item => `
                <div class="summary-box">
                    <p class="summary-box-label">${item.label}</p>
                    <p class="summary-box-value">${item.value}</p>
                </div>
            `).join('');
            
            const payoutHTML = deathPayouts.map(item => `
                <div class="summary-box col-span-2">
                    <p class="summary-box-label">${item.label}</p>
                    <p class="summary-box-value">${item.value}</p>
                </div>
            `).join('');

            clientSummaryEl.innerHTML = `
                ${primarySummaryHTML}
                <div class="md:col-start-1 lg:col-start-5 col-span-2">
                    ${payoutHTML}
                </div>
            `;
        }


        function updateTimeline() {
            const goal = savingsGoalSelect.value;
            const paymentTerm = parseInt(paymentTermInput.value) || 0;
            const policyPeriod = parseInt(policyPeriodInput.value) || 0;
            const clientAge = parseInt(clientAgeInput.value) || 0;
            const parentAge = parseInt(parentAgeInput.value) || 0;

            const paymentEndPercent = (paymentTerm / policyPeriod) * 100;
            
            document.getElementById('paymentProgressBar').style.width = `${paymentEndPercent}%`;
            document.getElementById('paymentEndMilestone').style.left = `${paymentEndPercent}%`;

            let startText = `Age ${clientAge}<br>Start`;
            let paymentEndText = `Age ${clientAge + paymentTerm}<br>Saving Term Ends`;
            let maturityText = `Age ${clientAge + policyPeriod}<br>Maturity`;

            if (goal === 'education') {
                startText = `Child Age ${clientAge}<br>Parent Age ${parentAge}`;
                paymentEndText = `Child Age ${clientAge + paymentTerm}<br>Parent Age ${parentAge + paymentTerm}`;
                maturityText = `Child Age ${clientAge + policyPeriod}<br>Fund Matures`;
            }

            document.getElementById('startLabel').innerHTML = startText;
            document.getElementById('paymentEndLabel').innerHTML = paymentEndText;
            document.getElementById('maturityLabel').innerHTML = maturityText;
        }

        function updateProtectionNarrative() {
            const selectedYear = parseInt(protectionYearSlider.value);
            protectionYearLabel.textContent = selectedYear;

            const goal = savingsGoalSelect.value;
            const isJuvenile = juvenilePolicyCheckbox.checked;
            const annualPremium = parseFloat(annualPremiumInput.value) || 0;
            const paymentTerm = parseInt(paymentTermInput.value) || 0;
            const deathPayoutEarly = parseFloat(deathPayoutEarlyInput.value) || 0;
            const deathPayoutLate = parseFloat(deathPayoutLateInput.value) || 0;
            const juvenileLien = [0.4, 0.6, 0.8, 1.0, 1.0];

            const totalPremiumsPaidByYear = Math.min(selectedYear, paymentTerm) * annualPremium;
            const futurePremiums = Math.max(0, paymentTerm - selectedYear) * annualPremium;
            
            let deathBenefit = 0;
            if (selectedYear <= 5) {
                deathBenefit = isJuvenile ? deathPayoutEarly * juvenileLien[selectedYear-1] : deathPayoutEarly;
            } else {
                deathBenefit = deathPayoutLate;
            }

            const leverage = (totalPremiumsPaidByYear > 0) ? (deathBenefit / totalPremiumsPaidByYear).toFixed(1) : 'N/A';
            
            let title = '';
            let narrativeHTML = '';
            let icon = '';

            switch (goal) {
                case 'education':
                    title = `How Your Child's Goal is Protected`;
                    icon = 'graduation-cap';
                    narrativeHTML = `
                        <p class="text-center font-semibold">Should unforeseen circumstances affect the parent in Year ${selectedYear}:</p>
                        <div class="flex justify-between text-sm"><span class="text-slate-500">Total Savings:</span> <strong>${formatCurrency(totalPremiumsPaidByYear)}</strong></div>
                        <div class="flex justify-between text-sm"><span class="text-slate-500">Future Savings Waived:</span> <strong>${formatCurrency(futurePremiums)}</strong></div>
                        <div class="flex justify-between text-sm mt-2 pt-2 border-t"><span class="text-slate-500">Guaranteed Final Payout:</span> <strong class="text-blue-600">${formatCurrency(finalGuaranteedPayout)}</strong></div>
                        <div class="flex justify-between text-sm"><span class="text-slate-500">Projected Final Payout:</span> <strong class="text-green-600">${formatCurrency(finalProjectedPayout)}</strong></div>
                        <p class="text-xs text-center text-slate-500 mt-2">The plan ensures the child's education fund is achieved, providing complete peace of mind.</p>
                    `;
                    break;
                case 'retirement':
                    title = `How Your Retirement is Safeguarded`;
                    icon = 'shield-check';
                     narrativeHTML = `
                        <p class="text-center font-semibold">Should you be unable to contribute due to disability in Year ${selectedYear}:</p>
                        <div class="flex justify-between text-sm"><span class="text-slate-500">Total Savings:</span> <strong>${formatCurrency(totalPremiumsPaidByYear)}</strong></div>
                        <div class="flex justify-between text-sm"><span class="text-slate-500">Future Savings Waived:</span> <strong>${formatCurrency(futurePremiums)}</strong></div>
                        <div class="flex justify-between text-sm mt-2 pt-2 border-t"><span class="text-slate-500">Guaranteed Final Payout:</span> <strong class="text-blue-600">${formatCurrency(finalGuaranteedPayout)}</strong></div>
                        <div class="flex justify-between text-sm"><span class="text-slate-500">Projected Final Payout:</span> <strong class="text-green-600">${formatCurrency(finalProjectedPayout)}</strong></div>
                        <p class="text-xs text-center text-slate-500 mt-2">Your retirement nest egg is secured, even if you can no longer work to contribute.</p>
                    `;
                    break;
                case 'legacy':
                    title = `How Your Legacy is Guaranteed`;
                    icon = 'wallet';
                    narrativeHTML = `
                        <p class="text-center font-semibold">Should the plan be activated for your nominee in Year ${selectedYear}:</p>
                        <div class="flex justify-between text-sm"><span class="text-slate-500">Total Savings:</span> <strong>${formatCurrency(totalPremiumsPaidByYear)}</strong></div>
                        <div class="flex justify-between text-sm"><span class="text-slate-500">Immediate Payout to Nominee:</span> <strong class="text-blue-600">${formatCurrency(deathBenefit)}</strong></div>
                        <div class="flex justify-between text-sm"><span class="text-slate-500">Immediate Leverage:</span> <strong class="text-blue-600">${leverage}x your savings</strong></div>
                        <p class="text-xs text-center text-slate-500 mt-2">This provides an immediate, significant estate for your loved ones, far exceeding your contributions.</p>
                    `;
                    break;
            }
            protectionTitle.textContent = title;
            protectionNarrative.innerHTML = `
                <div class="flex flex-col items-center space-y-4">
                    <i data-lucide="${icon}" class="w-12 h-12 text-blue-500 animate-in fade-in zoom-in duration-500"></i>
                    <div class="w-full text-left">
                        ${narrativeHTML}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }


        function renderTable(rows) {
            savingsTableBody.innerHTML = '';
            // Update the interest rate in the table header
            interestRateHeader.textContent = (interestRate * 100).toFixed(1);
            if (rows && rows.length > 0) {
                 rows.forEach((row, index) => {
                     const tr = document.createElement('tr');
                     tr.className = `border-b border-slate-200 table-row-hover ${index % 2 === 1 ? 'bg-gray-50' : ''}`; // Add alternating background color
                    
                     const premiumCellContent = row.premiumPaidThisYear > 0 ? formatCurrency(row.premiumPaidThisYear) : '-';
                    
                     tr.innerHTML = `
                         <td class="p-3 text-center w-1/12">${row.year}</td>
                         <td class="p-3 text-right w-2/12">${premiumCellContent}</td>
                         <td class="p-3 text-right w-1/12">${(row.percentage || 0).toFixed(0)}%</td>
                         <td class="p-3 text-right w-3/12">${formatCurrency(row.annualPayout || 0)}</td>
                         <td class="p-3 text-right w-5/12">${formatCurrency(row.total || 0)}</td>
                     `;
                     tr.addEventListener('click', () => openEditModal(row.year));
                     tr.addEventListener('mouseover', () => highlightChartPoint(index));
                     tr.addEventListener('mouseout', () => highlightChartPoint(-1)); // Unhighlight
                     savingsTableBody.appendChild(tr);
                 });
            } else {
                 savingsTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-slate-500">Please enter values and click "Calculate" to see the table.</td></tr>';
            }
        }
        
        function highlightChartPoint(index) {
            if (lineChartInstance) {
                // Determine the correct data points to highlight
                let activeElements = [];
                if (index !== -1) {
                    activeElements = [
                        { datasetIndex: 0, index: index }, // Projected Payout
                        { datasetIndex: 1, index: index }, // Guaranteed Payout
                        { datasetIndex: 2, index: index }, // Total Savings
                        { datasetIndex: 3, index: index },  // Protection Payout
                    ];
                }
                // Update the chart to show the new active elements
                lineChartInstance.setActiveElements(activeElements);
                lineChartInstance.update();
            }
        }


        function renderSummary(totalPremiums, guaranteedPayout, projectedPayout, accumulatedPayout, maturity, nonGuaranteed, paymentTerm, goal, clientAge, parentAge) {
            const totalGrowth = projectedPayout - totalPremiums;
            const growthPercentage = totalPremiums > 0 ? (totalGrowth / totalPremiums) * 100 : 0;

            totalAccumulatedGuaranteedPayoutEl.textContent = formatCurrency(accumulatedPayout);
            guaranteedMaturityEl.textContent = formatCurrency(maturity);
            totalGuaranteedPayoutEl.textContent = formatCurrency(guaranteedPayout);
            guaranteedForEquationEl.textContent = formatCurrency(guaranteedPayout);
            cashValueEl.textContent = formatCurrency(nonGuaranteed);
            totalProjectedPayoutEl.textContent = formatCurrency(projectedPayout);
            totalPremiumsEl.textContent = formatCurrency(totalPremiums);
            totalPremiumsLabel.textContent = `Total Savings (${paymentTerm} years)`;
            totalGrowthEl.innerHTML = `${formatCurrency(totalGrowth)} <span class="text-xl">(${growthPercentage.toFixed(1)}%)</span>`;

            // Update new goal statement based on inputs
            let goalText = '';
            switch(goal) {
                case 'education':
                    goalText = `
                        <p class="text-sm font-medium text-slate-600 mb-1">Your child's education fund goal:</p>
                        <p class="text-2xl font-bold text-slate-800">Reaching ${formatCurrency(finalProjectedPayout)} by Age ${clientAge + policyPeriod}</p>
                    `;
                    break;
                case 'retirement':
                    goalText = `
                        <p class="text-sm font-medium text-slate-600 mb-1">Your retirement fund goal:</p>
                        <p class="text-2xl font-bold text-slate-800">Reaching ${formatCurrency(finalProjectedPayout)} by Age ${clientAge + policyPeriod}</p>
                    `;
                    break;
                case 'legacy':
                    goalText = `
                        <p class="text-sm font-medium text-slate-600 mb-1">Your legacy fund goal:</p>
                        <p class="text-2xl font-bold text-slate-800">Providing ${formatCurrency(finalProjectedPayout)} to your loved ones</p>
                    `;
                    break;
            }
            goalStatementEl.innerHTML = goalText;
        }

        // New function to render the benefits section with icons
        function renderBenefitsSection(paymentTerm, policyPeriod, goal) {
            benefitsSection.innerHTML = ''; // Clear existing content
            const benefitItems = [
                {
                    icon: 'wallet',
                    title: 'Guaranteed Payouts',
                    description: 'Receive annual guaranteed payouts from Year 1 to maturity.'
                },
                {
                    icon: 'shield-check',
                    title: 'Financial Safety Net',
                    description: 'Combines savings and protection for a secure financial future.'
                },
                {
                    icon: 'dollar-sign',
                    title: 'Short Saving Term',
                    description: `Save for only ${paymentTerm} years to enjoy a total policy period of ${policyPeriod} years.`
                },
                {
                    icon: 'heart-pulse',
                    title: 'Waiver Benefits',
                    description: 'Future savings are waived in case of TPD or critical illness.'
                }
            ];

            benefitItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex flex-col items-center text-center p-4 rounded-lg bg-white shadow-sm transition-transform duration-200 hover:scale-105 benefit-card';
                div.innerHTML = `
                    <div class="h-12 w-12 flex items-center justify-center bg-blue-500 rounded-full text-white mb-2">
                        <i data-lucide="${item.icon}" class="w-6 h-6"></i>
                    </div>
                    <p class="font-semibold text-slate-800 text-sm mb-1">${item.title}</p>
                    <p class="text-xs text-slate-500">${item.description}</p>
                `;
                benefitsSection.appendChild(div);
            });
            // Feather Icons requires a call to replace the tags with SVGs
            lucide.createIcons();
        }
        
        function renderLineChart(growthData) {
            if (lineChartInstance) {
                lineChartInstance.destroy();
            }

            // Dynamically calculate the suggested max for the Y-axis
            const allValues = [
                ...growthData.guaranteedPayoutValues,
                ...growthData.projectedPayoutValues,
                ...growthData.totalPremiumValues,
                ...growthData.protectionValues
            ];
            const maxVal = Math.max(...allValues);
            const suggestedMax = maxVal * 1.15; // Add a 15% buffer to the top

            // Create a dedicated dataset for the final label
            const projectedLabelData = Array(growthData.projectedPayoutValues.length).fill(null);
            if (growthData.projectedPayoutValues.length > 0) {
                projectedLabelData[growthData.projectedPayoutValues.length - 1] = growthData.projectedPayoutValues[growthData.projectedPayoutValues.length - 1];
            }

            const data = {
                labels: growthData.labels,
                datasets: [
                    {
                        label: 'Total Guaranteed Payout',
                        data: growthData.guaranteedPayoutValues,
                        borderColor: '#2563eb', // Corporate Blue
                        backgroundColor: '#2563eb',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 3,
                        pointBackgroundColor: '#2563eb',
                        order: 0,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Total Projected Payout',
                        data: growthData.projectedPayoutValues,
                        borderColor: '#16a34a', // Green
                        backgroundColor: '#16a34a',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 3,
                        pointBackgroundColor: '#16a34a',
                        order: 1,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Total Savings',
                        data: growthData.totalPremiumValues,
                        borderColor: '#a0aec0', // Light Gray
                        backgroundColor: '#a0aec0',
                        fill: false,
                        borderDash: [5, 5],
                        tension: 0.1,
                        pointRadius: 3,
                        pointBackgroundColor: '#a0aec0',
                        order: 2,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Protection Payout',
                        data: growthData.protectionValues,
                        borderColor: '#f43f5e', // Red/Pink for protection
                        backgroundColor: '#f43f5e',
                        fill: false,
                        stepped: true,
                        order: 3,
                        yAxisID: 'y',
                    },
                    // NEW: Dedicated dataset for the final label
                    {
                        label: 'Final Payout',
                        data: projectedLabelData,
                        borderColor: 'transparent',
                        backgroundColor: 'transparent',
                        pointRadius: 0,
                        fill: false,
                        showLine: false,
                        datalabels: {
                            color: '#16a34a',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                ]
            };

            lineChartInstance = new Chart(growthChartCanvas, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    layout: {
                        padding: {
                            right: 50 // Add padding to the right
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#334155', boxWidth: 12, padding: 20 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                },
                                afterBody: function(context) {
                                    const annualPayout = growthData.annualPayoutValues[context[0].dataIndex];
                                    return `Annual Payout: ${formatCurrency(annualPayout)}`;
                                }
                            }
                        },
                        datalabels: {
                            // This is the main datalabels configuration for all datasets
                            align: 'end',
                            anchor: 'end',
                            offset: 8,
                            backgroundColor: 'rgba(255, 255, 255, 0.8)',
                            borderRadius: 4,
                            padding: 6,
                            color: '#1e293b',
                            font: {
                                weight: 'bold'
                            },
                            formatter: function(value, context) {
                                // Only show labels for specific datasets and points
                                const data = context.dataset.data;
                                if (!data || data.length === 0) return null;

                                const isFinalPoint = context.dataIndex === context.dataset.data.length - 1;
                                
                                // Show label for the final point on guaranteed and projected lines
                                const isProjectedOrGuaranteed = context.dataset.label === 'Total Projected Payout' || context.dataset.label === 'Total Guaranteed Payout';
                                if (isProjectedOrGuaranteed && isFinalPoint) {
                                     return formatCurrency(value);
                                }

                                // Show label for the max point on the savings line
                                if (context.dataset.label === 'Total Savings') {
                                    const max_value = Math.max(...data);
                                    const first_max_index = data.indexOf(max_value);
                                    if (context.dataIndex === first_max_index) {
                                        return formatCurrency(value);
                                    }
                                }

                                return null;
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            ticks: { color: '#475569', callback: value => formatCurrency(value) },
                            grid: { color: '#e2e8f0' },
                            // FIX: Added a suggestedMax to the y-axis to provide top padding
                            suggestedMax: suggestedMax
                        },
                        x: {
                            ticks: { color: '#475569' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function switchTab(tab) {
            tabTableBtn.classList.remove('active');
            tabChartBtn.classList.remove('active');
            tabProtectionBtn.classList.remove('active');
            tableContent.classList.add('hidden');
            chartContent.classList.add('hidden');
            protectionContent.classList.add('hidden');

            if (tab === 'chart') {
                tabChartBtn.classList.add('active');
                chartContent.classList.remove('hidden');
            } else if (tab === 'table') {
                tabTableBtn.classList.add('active');
                tableContent.classList.remove('hidden');
            } else if (tab === 'protection') {
                tabProtectionBtn.classList.add('active');
                protectionContent.classList.remove('hidden');
            }
        }

        function openEditModal(year) {
            currentlyEditingYear = year;
            modalTitle.textContent = `Edit Year ${year} Guaranteed Payout`;
            modalSavingsInput.value = guaranteedPayoutsData[year - 1];
            modalPercentageInput.value = percentageData[year - 1];
            applyToFollowingCheckbox.checked = false;
            editModal.classList.remove('hidden');
        }

        function closeModal() {
            editModal.classList.add('hidden');
            currentlyEditingYear = -1;
        }

        function saveChanges() {
            const newGuaranteedPayout = parseFloat(modalSavingsInput.value);
            const newPercentage = parseFloat(modalPercentageInput.value);
            if (isNaN(newGuaranteedPayout) || isNaN(newPercentage) || currentlyEditingYear === -1) {
                return;
            }

            const yearIndex = currentlyEditingYear - 1;
            guaranteedPayoutsData[yearIndex] = newGuaranteedPayout;
            percentageData[yearIndex] = newPercentage;

            if (applyToFollowingCheckbox.checked) {
                for (let i = yearIndex + 1; i < policyPeriod; i++) {
                    guaranteedPayoutsData[i] = newGuaranteedPayout;
                    percentageData[i] = newPercentage;
                }
            }

            calculateAndRender();
            closeModal();
        }
        
        // This is a temporary message box for the user, instead of alert()
        function showTemporaryMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.textContent = message;
            messageBox.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg bg-blue-600 text-white z-50 transition-all duration-300 ease-in-out transform scale-100';
            document.body.appendChild(messageBox);
            setTimeout(() => {
                messageBox.classList.add('scale-0');
                messageBox.addEventListener('transitionend', () => messageBox.remove());
            }, 3000);
        }

        function formatCurrency(amount) {
            return 'RM ' + new Intl.NumberFormat('en-MY', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

    </script>
</body>
</html>
