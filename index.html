<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savings + Protection Illustrator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Light Gray/Off-white background */
            color: #1e293b; /* Dark Slate text */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #e2e8f0;
        }
        .section-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #1e293b; /* text-slate-800 */
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #2563eb; /* Corporate Blue underline */
            display: inline-block;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-color: #2563eb; /* Corporate Blue */
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color: 0.3s;
        }
        .btn-primary:hover {
            background-color: #1d4ed8; /* Darker Blue */
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #475569;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color: 0.3s;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
        .table-header {
            background-color: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }
        .table-row-hover:hover {
            background-color: #f8fafc;
            cursor: pointer;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: #ffffff;
            color: #1e293b;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 400px;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            color: #475569;
        }
        .tab-button.active {
            color: #2563eb; /* Corporate Blue for active tab */
            border-bottom-color: #2563eb;
        }
        /* Custom slider styles */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            margin-top: -8px; 
        }
        input[type=range]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 5px;
        }
        .summary-box {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }
        .summary-box-label {
            font-size: 0.875rem; /* text-sm */
            color: #64748b; /* text-slate-500 */
        }
        .summary-box-value {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #1e293b; /* text-slate-800 */
        }
        .benefit-card {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            display: flex;
            gap: 1.5rem;
        }
        .benefit-card .icon-container {
            flex-shrink: 0;
            width: 3rem;
            height: 3rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- NEW: Contribution & Payouts Timeline --- */
        .contribution-timeline-wrapper {
            width: 100%;
            display: grid;
            grid-template-rows: 30px 20px 30px;
            gap: 8px; /* Creates vertical space */
        }
        .timeline-section {
            position: relative;
        }
        .timeline-bar {
            position: absolute;
            height: 100%;
            background-color: #3b82f6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            padding: 0 10px;
            box-sizing: border-box;
        }
        .timeline-bar.receive-bar {
            background-color: #22c55e;
        }
        .timeline-axis-wrapper {
            width: 100%;
            position: relative;
        }
        .timeline-axis {
            width: 100%;
            height: 2px;
            background-color: #cbd5e1;
            position: absolute;
            top: 0;
        }
        .timeline-years {
            display: flex;
            justify-content: space-around;
        }
        .timeline-year {
            flex: 1;
            text-align: center;
            font-size: 0.7rem;
            color: #64748b;
            position: relative;
            padding-top: 6px; /* Space for the tick mark */
        }
        .timeline-year::before {
             content: '';
             position: absolute;
             top: -4px;
             left: 50%;
             transform: translateX(-50%);
             width: 2px;
             height: 8px; /* The height of the tick */
             background-color: #cbd5e1;
        }
        .timeline-maturity-flag {
            position: absolute;
            top: -22px; /* Position above the axis */
            right: 0;
            transform: translateX(50%);
            font-size: 0.7rem;
            font-weight: 600;
            color: #ef4444;
        }
        
        /* Print styles */
        @media print {
            body {
                background-color: #fff;
                color: #000;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }
            #detailsSection .hidden, #customizedBenefitsSection .hidden {
                display: block !important;
            }
            .btn-primary, .btn-secondary, nav, #editModal, .modal-backdrop {
                display: none !important;
            }
            #customizedBenefitsSection {
                display: grid; grid-template-columns: 1fr; gap: 1rem;
            }
            #chartContent {
                 height: 400px;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto space-y-8">
        <h1 class="text-4xl font-bold text-center text-slate-800">Savings + Protection Illustrator</h1>

        <!-- 1. Client & Product Details -->
        <div class="card">
            <h2 class="section-title">Client & Product Details</h2>
            <div class="space-y-6">
                <!-- Personal Information -->
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Your Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                         <!-- Name Input -->
                        <div class="lg:col-span-4">
                            <label for="clientName" class="block text-sm font-medium text-slate-600">Client's Name</label>
                            <input type="text" id="clientName" placeholder="e.g. John Doe" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-md">
                        </div>
                        <!-- Goal Selector -->
                        <div class="lg:col-span-4">
                            <label for="savingsGoal" class="block text-sm font-medium text-slate-600">Primary Savings Goal</label>
                            <select id="savingsGoal" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-md">
                                <option value="education">Education Fund (for a child)</option>
                                <option value="retirement">Retirement Plan (for self)</option>
                                <option value="legacy">Legacy</option>
                            </select>
                        </div>

                        <!-- Age Inputs -->
                        <div id="ageInputs" class="lg:col-span-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div>
                                <label for="clientAge" class="block text-sm font-medium text-slate-600">Client's Current Age</label>
                                <input type="number" id="clientAge" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-md">
                            </div>
                            <div id="parentAgeWrapper" class="hidden">
                                <label for="parentAge" class="block text-sm font-medium text-slate-600">Parent's Current Age</label>
                                <input type="number" id="parentAge" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-md">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Policy Parameters -->
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Policy Parameters</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Financial Inputs -->
                        <div>
                            <label for="annualPremium" class="block text-sm font-medium text-slate-600">Yearly Saving (RM)</label>
                            <input type="number" id="annualPremium" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-md">
                        </div>
                        <div>
                            <label for="paymentTerm" class="block text-sm font-medium text-slate-600">Saving Term (years)</label>
                            <input type="number" id="paymentTerm" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-md" value="10">
                        </div>
                        <div>
                            <label for="annualGuaranteedPayout" class="block text-sm font-medium text-slate-600">Annual Payout (RM)</label>
                            <input type="number" id="annualGuaranteedPayout" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-md">
                        </div>
                        <div>
                            <label for="policyPeriod" class="block text-sm font-medium text-slate-600">Total Policy Period (years)</label>
                            <input type="number" id="policyPeriod" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-md" value="20">
                        </div>
                        <div>
                            <label for="interestRate" class="block text-sm font-medium text-slate-600">Interest Rate (%)</label>
                            <input type="number" id="interestRate" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-md" value="4.8">
                        </div>
                        <div>
                            <label for="maturityValue" class="block text-sm font-medium text-slate-600">Guaranteed Maturity Payout (b)</label>
                            <input type="number" id="maturityValue" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-md">
                        </div>
                        <div>
                            <label for="nonGuaranteedValue" class="block text-sm font-medium text-slate-600">Maturity Bonus (c)</label>
                            <input type="number" id="nonGuaranteedValue" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-md">
                        </div>
                        
                        <!-- Protection Inputs -->
                        <div>
                            <label for="deathPayoutEarly" class="block text-sm font-medium text-slate-600">Sum Assured (Yrs 1-5)</label>
                            <input type="number" id="deathPayoutEarly" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-md">
                        </div>
                        <div>
                            <label for="deathPayoutLate" class="block text-sm font-medium text-slate-600">Sum Assured (Yrs 6+)</label>
                            <input type="number" id="deathPayoutLate" class="w-full mt-1 p-2 bg-white border border-slate-300 rounded-md">
                        </div>
                        <div class="flex items-end justify-start">
                            <div class="flex items-center">
                                <input id="juvenilePolicy" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="juvenilePolicy" class="ml-2 block text-sm text-slate-600">This is a Juvenile Policy</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Riders & Waivers Section -->
                 <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Riders & Waivers</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="flex items-center">
                            <input id="pruLegacyCheckbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="pruLegacyCheckbox" class="ml-2 block text-sm text-slate-600">PruLegacy</label>
                        </div>
                        <div class="flex items-center">
                            <input id="pruWaiverCheckbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="pruWaiverCheckbox" class="ml-2 block text-sm text-slate-600">PruWaiver</label>
                        </div>
                        <div class="flex items-center">
                            <input id="parentWaiverCheckbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="parentWaiverCheckbox" class="ml-2 block text-sm text-slate-600">Parent Waiver</label>
                        </div>
                    </div>
                 </div>
            </div>
            
             <!-- Separated Save/Load/Calculate buttons for better hierarchy -->
             <div class="mt-8 flex items-end justify-end space-x-2">
                 <button id="saveBtn" class="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">Save</button>
                 <button id="loadBtn" class="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">Load</button>
                 <button id="calculateBtn" class="btn-primary">Calculate</button>
             </div>
        </div>
        
        <!-- 2. Overall Summary -->
        <div id="summaryCard" class="card">
            <h2 class="section-title">Overall Summary</h2>

            <!-- NEW: Contribution & Payouts Timeline -->
            <div class="my-8">
                 <p class="text-lg font-semibold text-slate-700 text-center mb-4">Your Savings & Rewards Journey</p>
                 <div id="contributionTimeline" class="contribution-timeline-wrapper">
                    <!-- Bars will be dynamically inserted here -->
                 </div>
            </div>

            <!-- Fund Goal -->
            <div id="goalStatement" class="text-center bg-gray-50 border border-gray-200 rounded-lg p-4 mb-8">
                <!-- Content dynamically generated -->
            </div>
            
            <!-- Key Metrics -->
            <div id="clientSummary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <!-- Content is dynamically generated -->
            </div>
        </div>

        <!-- 3. The payout table / growth chart -->
        <div id="detailsSection" class="card">
            <div class="border-b border-slate-200 mb-4">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="tabTable" class="tab-button active">Payout Table</button>
                    <button id="tabChart" class="tab-button">Growth Chart</button>
                </nav>
            </div>
            
            <!-- Tab Content -->
            <div>
                <div id="tableContent">
                    <p class="text-sm text-slate-500 mb-4">Tap a row to edit the guaranteed payout for that year.</p>
                    <div class="flex justify-center">
                        <table class="w-full text-left">
                            <thead class="table-header sticky top-0">
                                <tr>
                                    <th class="p-3 font-semibold text-center w-1/12">Year</th>
                                    <th class="p-3 font-semibold text-right w-3/12">Yearly Saving</th>
                                    <th class="p-3 font-semibold text-right w-4/12">Cash every year</th>
                                    <th class="p-3 text-right font-semibold w-4/12">Keep to Grow (<span id="interestRateHeader">0.0</span>% p.a.)</th>
                                </tr>
                            </thead>
                            <tbody id="savingsTableBody">
                                <tr><td colspan="4" class="text-center p-4 text-slate-500">Please enter values and click "Calculate" to see the table.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="chartContent" class="hidden">
                    <div class="h-96">
                         <canvas id="growthChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 4. Final Payouts & Performance -->
        <div class="card mt-8">
            <h2 class="section-title">Final Payouts & Performance</h2>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 items-center">
                <!-- Left Card: Your Total Savings -->
                <div class="lg:col-span-2 flex flex-col text-center items-center justify-center p-6 rounded-lg bg-slate-50 border h-full">
                     <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-slate-500 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 5.5c-1.3 1.4-1.3 3.6 0 5"/><path d="M16.5 10.5c0-3-2.5-5.5-5.5-5.5s-5.5 2.5-5.5 5.5c0 2.2 1.3 4 3 4.8V19c0 1.1.9 2 2 2h2a2 2 0 0 0 2-2v-3.7c1.7-.8 3-2.6 3-4.8Z"/><path d="M2 12c0-3.3 2.7-6 6-6"/><path d="M22 12c0-3.3-2.7-6-6-6"/></svg>
                    <p id="totalPremiumsLabel" class="text-md font-semibold text-slate-700">Total Savings</p>
                    <p id="totalPremiums" class="text-4xl font-bold text-slate-800 mt-1">RM 0</p>
                </div>
        
                <!-- Connector -->
                <div class="text-center">
                     <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-slate-400 mx-auto" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                </div>
        
                <!-- Right Card: Your Total Return -->
                <div class="lg:col-span-2 p-6 rounded-lg border border-blue-300 bg-blue-50/50 h-full">
                     <div class="space-y-3">
                        <div class="flex justify-between items-baseline">
                            <p class="text-sm text-slate-700">Accumulated Payouts (a)</p>
                            <p id="totalAccumulatedGuaranteedPayout" class="text-lg font-semibold text-slate-800">RM 0</p>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <p class="text-sm text-slate-700">Maturity Payout (b)</p>
                            <p id="guaranteedMaturity" class="text-lg font-semibold text-slate-800">RM 0</p>
                        </div>
                         <div class="flex justify-between items-baseline">
                            <p class="text-sm text-green-700">Maturity Bonus (c)</p>
                            <p id="cashValue" class="text-lg font-semibold text-green-800">RM 0</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-blue-200">
                        <p class="text-md font-medium text-blue-800">Total Maturity (a+b+c)</p>
                        <p id="totalProjectedPayout" class="text-4xl font-bold text-blue-800">RM 0</p>
                    </div>
                     <div class="mt-4 text-center bg-green-100/50 p-3 rounded-md">
                         <p class="text-sm font-semibold text-green-700">Projected Growth</p>
                         <p id="totalGrowth" class="text-2xl font-bold text-green-800">RM 0</p>
                     </div>
                </div>
            </div>
        </div>
        
        <!-- 5. NEW: Your Customized Protection Plan -->
        <div id="customizedBenefitsSection" class="card mt-8">
            <h2 class="section-title">Your Customized Protection Plan</h2>

            <!-- NEW: Interactive Slider -->
            <div class="p-4 rounded-lg bg-slate-50 border mb-6">
                <label for="protectionYearSlider" class="block text-sm font-medium text-slate-600 mb-2">Use the slider to see how your protection works in different years:</label>
                <input type="range" id="protectionYearSlider" min="1" max="20" value="1" class="w-full">
                <div class="text-center text-lg font-semibold mt-2">Protection Scenario for: <span class="text-blue-600">Year <span id="protectionYearLabel">1</span></span></div>
            </div>

            <div class="space-y-6">
                <!-- Death/TPD Card (Always Visible) -->
                <div id="deathTpdCard" class="benefit-card">
                    <div class="icon-container bg-red-100 text-red-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800">Death / Total & Permanent Disability (TPD)</h3>
                        <p class="text-sm text-slate-600 mt-1">Provides a lump sum payment to support your family's needs if the unforeseen happens.</p>
                        <div id="deathPayoutDetails" class="mt-3 pt-3 border-t text-sm space-y-2">
                             <!-- Dynamic content will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- PruLegacy Card -->
                <div id="pruLegacyCard" class="benefit-card hidden">
                    <div class="icon-container bg-sky-100 text-sky-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800">PruLegacy: Continuous Financial Certainty</h3>
                        <p class="text-sm text-slate-600 mt-1">This will continue to provide a steady stream of annual payouts for your loved ones when you are no longer able to support them upon death or TPD.</p>
                        <div class="mt-3 pt-3 border-t text-sm space-y-2">
                             <div class="flex justify-between"><span>Annual Payouts Continue:</span> <strong id="pruLegacyPayout" class="font-semibold">RM 0 / year</strong></div>
                        </div>
                    </div>
                </div>
                
                <!-- PruWaiver Card -->
                <div id="pruWaiverCard" class="benefit-card hidden">
                    <div class="icon-container bg-purple-100 text-purple-600">
                         <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800">PruWaiver: Auto Save</h3>
                        <p class="text-sm text-slate-600 mt-1">Waives all future savings for the plan in the event that you are diagnosed with a critical illness, ensuring your savings goal stays on track.</p>
                         <div class="mt-3 pt-3 border-t text-sm space-y-2">
                             <div id="pruWaiverDetails"></div>
                        </div>
                    </div>
                </div>

                <!-- Parent Waiver Card -->
                <div id="parentWaiverCard" class="benefit-card hidden">
                     <div class="icon-container bg-amber-100 text-amber-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800">Parent Waiver: Secure Your Child's Future</h3>
                        <p class="text-sm text-slate-600 mt-1">Should the parent pass away, suffer TPD, or be diagnosed with a critical illness, all future savings will be waived, guaranteeing the child's fund is secure.</p>
                         <div class="mt-3 pt-3 border-t text-sm space-y-2">
                            <div id="parentWaiverDetails"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="flex justify-center mt-8">
            <button id="generatePdfBtn" class="btn-secondary hidden">Generate Report (PDF)</button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-backdrop hidden">
        <div class="modal-content text-center">
            <h3 id="modalTitle" class="text-xl font-bold mb-4">Edit Year 1 Guaranteed Payout</h3>
             <div class="mb-4">
                 <label for="modalSavingsInput" class="block text-sm font-medium text-slate-600 text-left">Guaranteed Annual Payout (RM)</label>
                 <input type="number" id="modalSavingsInput" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-md text-center text-2xl">
            </div>
            <!-- Removed the percentage input block -->
            <div class="flex items-center justify-center mb-6">
                <input id="applyToFollowing" type="checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
                <label for="applyToFollowing" class="ml-2 block text-sm text-slate-600">Apply to the following years</label>
            </div>
            <div class="flex justify-center space-x-4">
                <button id="cancelBtn" class="py-2 px-8 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">Cancel</button>
                <button id="saveModalBtn" class="py-2 px-10 btn-primary">OK</button>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const calculateBtn = document.getElementById('calculateBtn');
        const saveScenarioBtn = document.getElementById('saveBtn');
        const loadScenarioBtn = document.getElementById('loadBtn');
        const generatePdfBtn = document.getElementById('generatePdfBtn');
        const savingsGoalSelect = document.getElementById('savingsGoal');
        const juvenilePolicyCheckbox = document.getElementById('juvenilePolicy');
        const clientAgeInput = document.getElementById('clientAge');
        const parentAgeInput = document.getElementById('parentAge');
        const ageInputs = document.getElementById('ageInputs');
        const parentAgeWrapper = document.getElementById('parentAgeWrapper');
        const annualPremiumInput = document.getElementById('annualPremium');
        const paymentTermInput = document.getElementById('paymentTerm');
        const annualGuaranteedPayoutInput = document.getElementById('annualGuaranteedPayout');
        const policyPeriodInput = document.getElementById('policyPeriod');
        const interestRateInput = document.getElementById('interestRate');
        const maturityValueInput = document.getElementById('maturityValue');
        const nonGuaranteedValueInput = document.getElementById('nonGuaranteedValue');
        const deathPayoutEarlyInput = document.getElementById('deathPayoutEarly');
        const deathPayoutLateInput = document.getElementById('deathPayoutLate');
        const clientNameInput = document.getElementById('clientName');
        
        // Rider Checkboxes
        const pruLegacyCheckbox = document.getElementById('pruLegacyCheckbox');
        const pruWaiverCheckbox = document.getElementById('pruWaiverCheckbox');
        const parentWaiverCheckbox = document.getElementById('parentWaiverCheckbox');

        // Customized Benefit Cards
        const deathPayoutDetails = document.getElementById('deathPayoutDetails');
        const pruLegacyCard = document.getElementById('pruLegacyCard');
        const pruWaiverCard = document.getElementById('pruWaiverCard');
        const parentWaiverCard = document.getElementById('parentWaiverCard');
        const pruLegacyPayout = document.getElementById('pruLegacyPayout');
        const pruWaiverDetails = document.getElementById('pruWaiverDetails');
        const parentWaiverDetails = document.getElementById('parentWaiverDetails');
        
        const savingsTableBody = document.getElementById('savingsTableBody');
        const summaryCard = document.getElementById('summaryCard');
        const detailsSection = document.getElementById('detailsSection');
        const goalStatementEl = document.getElementById('goalStatement');
        const clientSummaryEl = document.getElementById('clientSummary');

        // Contribution Timeline Elements
        const contributionTimelineContainer = document.getElementById('contributionTimeline');
        
        // Summary Card Elements
        const totalProjectedPayoutEl = document.getElementById('totalProjectedPayout');
        const totalPremiumsEl = document.getElementById('totalPremiums');
        const totalPremiumsLabel = document.getElementById('totalPremiumsLabel');
        const totalAccumulatedGuaranteedPayoutEl = document.getElementById('totalAccumulatedGuaranteedPayout');
        const guaranteedMaturityEl = document.getElementById('guaranteedMaturity');
        const cashValueEl = document.getElementById('cashValue');
        const totalGrowthEl = document.getElementById('totalGrowth');
        
        const growthChartCanvas = document.getElementById('growthChart');
        
        // Tab Elements
        const tabChartBtn = document.getElementById('tabChart');
        const tabTableBtn = document.getElementById('tabTable');
        
        // Protection Elements
        const protectionYearSlider = document.getElementById('protectionYearSlider');
        const protectionYearLabel = document.getElementById('protectionYearLabel');
        
        // Modal Elements
        const editModal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalSavingsInput = document.getElementById('modalSavingsInput');
        const applyToFollowingCheckbox = document.getElementById('applyToFollowing');
        const saveModalBtn = document.getElementById('saveModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        // App state
        let guaranteedPayoutsData = [];
        let policyPeriod = 0;
        let lineChartInstance = null;
        let currentlyEditingYear = -1;
        let accumulatedValues = [];
        
        Chart.register(ChartDataLabels);

        // --- Event Listeners ---
        calculateBtn.addEventListener('click', runInitialCalculation);
        saveScenarioBtn.addEventListener('click', saveScenario);
        loadScenarioBtn.addEventListener('click', loadScenario);
        generatePdfBtn.addEventListener('click', () => window.print());
        saveModalBtn.addEventListener('click', saveChanges);
        cancelBtn.addEventListener('click', closeModal);
        tabChartBtn.addEventListener('click', () => switchTab('chart'));
        tabTableBtn.addEventListener('click', () => switchTab('table'));
        
        savingsGoalSelect.addEventListener('change', () => {
            if (savingsGoalSelect.value === 'education') {
                parentAgeWrapper.classList.remove('hidden');
                clientAgeInput.previousElementSibling.textContent = "Child's Current Age";
            } else {
                parentAgeWrapper.classList.add('hidden');
                clientAgeInput.previousElementSibling.textContent = "Client's Current Age";
            }
        });
        protectionYearSlider.addEventListener('input', renderCustomizedBenefits);

        // Rider & policy type listeners
        pruLegacyCheckbox.addEventListener('change', calculateAndRender);
        pruWaiverCheckbox.addEventListener('change', calculateAndRender);
        parentWaiverCheckbox.addEventListener('change', calculateAndRender);
        juvenilePolicyCheckbox.addEventListener('change', calculateAndRender);

        window.addEventListener('DOMContentLoaded', () => {
            initializeDefaultValues();
            calculateAndRender(); 
        });

        function initializeDefaultValues() {
            clientAgeInput.value = ''; parentAgeInput.value = '';
            annualPremiumInput.value = ''; annualGuaranteedPayoutInput.value = '';
            maturityValueInput.value = ''; nonGuaranteedValueInput.value = '';
            deathPayoutEarlyInput.value = ''; deathPayoutLateInput.value = '';
        }

        function runInitialCalculation() {
            policyPeriod = parseInt(policyPeriodInput.value);
            const initialGuaranteedPayout = parseFloat(annualGuaranteedPayoutInput.value);
            if (isNaN(policyPeriod) || isNaN(initialGuaranteedPayout) || policyPeriod <= 0) {
                showTemporaryMessage('Please enter valid inputs.');
                return;
            }
            guaranteedPayoutsData = Array(policyPeriod).fill(initialGuaranteedPayout);
            protectionYearSlider.max = policyPeriod;
            protectionYearSlider.value = 1;
            calculateAndRender();
            summaryCard.classList.remove('hidden');
            detailsSection.classList.remove('hidden');
            generatePdfBtn.classList.remove('hidden');
            switchTab('table');
        }

        function calculateAndRender() {
            const annualPremium = parseFloat(annualPremiumInput.value) || 0;
            const paymentTerm = parseInt(paymentTermInput.value) || 0;
            const maturityValue = parseFloat(maturityValueInput.value) || 0;
            const nonGuaranteedValue = parseFloat(nonGuaranteedValueInput.value) || 0;
            const interestRate = parseFloat(interestRateInput.value) / 100 || 0;
            policyPeriod = parseInt(policyPeriodInput.value) || 0;
            const deathPayoutEarly = parseFloat(deathPayoutEarlyInput.value) || 0;
            const deathPayoutLate = parseFloat(deathPayoutLateInput.value) || 0;
            const clientAge = parseInt(clientAgeInput.value) || 0;
            const isJuvenile = juvenilePolicyCheckbox.checked;

            let accumulatedPayoutValue = 0;
            let totalPremiumsPaid = 0;
            accumulatedValues = [];
            const tableRows = [];
            const growthData = {
                labels: [], projectedPayoutValues: [], guaranteedPayoutValues: [],
                totalPremiumValues: [], protectionValues: [], annualPayoutValues: [],
            };
            const juvenileLien = [0.4, 0.6, 0.8, 1.0, 1.0];
            if (!guaranteedPayoutsData || guaranteedPayoutsData.length !== policyPeriod) {
                 guaranteedPayoutsData = Array(policyPeriod).fill(parseFloat(annualGuaranteedPayoutInput.value) || 0);
            }
            for (let year = 1; year <= policyPeriod; year++) {
                let premiumPaidThisYear = (year <= paymentTerm) ? annualPremium : 0;
                totalPremiumsPaid += premiumPaidThisYear;
                const annualPayout = guaranteedPayoutsData[year - 1] || 0;
                accumulatedPayoutValue += (accumulatedPayoutValue * interestRate) + annualPayout;
                accumulatedValues.push(accumulatedPayoutValue);
                tableRows.push({ year, premiumPaidThisYear, annualPayout, total: accumulatedPayoutValue });
                let guaranteedPayoutForChart = accumulatedPayoutValue;
                let projectedPayoutForChart = accumulatedPayoutValue;
                if (year === policyPeriod) {
                    guaranteedPayoutForChart += maturityValue;
                    projectedPayoutForChart += maturityValue + nonGuaranteedValue;
                }
                let protectionPayout = deathPayoutLate;
                if (year <= 5) {
                    protectionPayout = isJuvenile ? deathPayoutEarly * juvenileLien[year-1] : deathPayoutEarly;
                }
                growthData.labels.push(`Year ${year}`);
                growthData.projectedPayoutValues.push(projectedPayoutForChart);
                growthData.guaranteedPayoutValues.push(guaranteedPayoutForChart);
                growthData.totalPremiumValues.push(totalPremiumsPaid);
                growthData.protectionValues.push(protectionPayout);
                growthData.annualPayoutValues.push(annualPayout);
            }
            const finalGuaranteedPayout = accumulatedPayoutValue + maturityValue;
            const finalProjectedPayout = finalGuaranteedPayout + nonGuaranteedValue;
            renderTable(tableRows);
            renderSummary(totalPremiumsPaid, finalGuaranteedPayout, finalProjectedPayout, accumulatedPayoutValue, maturityValue, nonGuaranteedValue, paymentTerm, savingsGoalSelect.value, clientAge);
            renderClientSummary(annualPremium, paymentTerm, totalPremiumsPaid, policyPeriod);
            renderLineChart(growthData);
            renderContributionTimeline();
            renderCustomizedBenefits(); 
        }
        
        function renderCustomizedBenefits() {
            const annualPremium = parseFloat(annualPremiumInput.value) || 0;
            const paymentTerm = parseInt(paymentTermInput.value) || 0;
            const annualPayout = parseFloat(annualGuaranteedPayoutInput.value) || 0;
            const deathPayoutEarly = parseFloat(deathPayoutEarlyInput.value) || 0;
            const deathPayoutLate = parseFloat(deathPayoutLateInput.value) || 0;
            const isJuvenile = juvenilePolicyCheckbox.checked;
            const juvenileLien = [0.4, 0.6, 0.8, 1.0, 1.0];
            const selectedYear = parseInt(protectionYearSlider.value);

            protectionYearLabel.textContent = selectedYear;
            deathPayoutDetails.innerHTML = ''; 

            if (isJuvenile) {
                deathPayoutDetails.innerHTML = `
                    <div class="flex justify-between"><span>Payout at Year 1 (40%):</span> <strong class="font-semibold">${formatCurrency(deathPayoutEarly * juvenileLien[0])}</strong></div>
                    <div class="flex justify-between"><span>Payout at Year 5 (100%):</span> <strong class="font-semibold">${formatCurrency(deathPayoutEarly * juvenileLien[4])}</strong></div>
                    <div class="flex justify-between"><span>Payout (Years 6+):</span> <strong class="font-semibold">${formatCurrency(deathPayoutLate)}</strong></div>
                `;
            } else {
                deathPayoutDetails.innerHTML = `
                    <div class="flex justify-between"><span>Payout (Years 1-5):</span> <strong class="font-semibold">${formatCurrency(deathPayoutEarly)}</strong></div>
                    <div class="flex justify-between"><span>Payout (Years 6+):</span> <strong class="font-semibold">${formatCurrency(deathPayoutLate)}</strong></div>
                `;
            }

            pruLegacyCard.classList.toggle('hidden', !pruLegacyCheckbox.checked);
            pruLegacyPayout.textContent = `${formatCurrency(annualPayout)} / year`;

            const remainingPremiums = Math.max(0, paymentTerm - selectedYear) * annualPremium;
            
            pruWaiverCard.classList.toggle('hidden', !pruWaiverCheckbox.checked);
            pruWaiverDetails.innerHTML = `<div class="text-xs text-slate-500 mb-1">Based on an event in Year ${selectedYear}:</div>
                <div class="flex justify-between"><span>Future Savings Waived:</span> <strong class="font-semibold">${formatCurrency(remainingPremiums)}</strong></div>`;

            parentWaiverCard.classList.toggle('hidden', !parentWaiverCheckbox.checked);
            parentWaiverDetails.innerHTML = `<div class="text-xs text-slate-500 mb-1">Based on an event in Year ${selectedYear}:</div>
                <div class="flex justify-between"><span>Future Savings Waived:</span> <strong class="font-semibold">${formatCurrency(remainingPremiums)}</strong></div>`;
        }

        function saveScenario() {
            const scenario = {
                savingsGoal: savingsGoalSelect.value, juvenilePolicy: juvenilePolicyCheckbox.checked,
                clientAge: clientAgeInput.value, parentAge: parentAgeInput.value,
                annualPremium: annualPremiumInput.value, paymentTerm: paymentTermInput.value,
                annualGuaranteedPayout: annualGuaranteedPayoutInput.value, policyPeriod: policyPeriodInput.value,
                interestRate: interestRateInput.value, maturityValue: maturityValueInput.value,
                nonGuaranteedValue: nonGuaranteedValueInput.value, deathPayoutEarly: deathPayoutEarlyInput.value,
                deathPayoutLate: deathPayoutLateInput.value, guaranteedPayoutsData: guaranteedPayoutsData,
                pruLegacy: pruLegacyCheckbox.checked, pruWaiver: pruWaiverCheckbox.checked, parentWaiver: parentWaiverCheckbox.checked,
            };
            localStorage.setItem('savedScenario', JSON.stringify(scenario));
            showTemporaryMessage("Scenario saved to local storage!");
        }
        
        function loadScenario() {
            const savedScenario = localStorage.getItem('savedScenario');
            if (savedScenario) {
                const scenario = JSON.parse(savedScenario);
                savingsGoalSelect.value = scenario.savingsGoal; juvenilePolicyCheckbox.checked = scenario.juvenilePolicy;
                clientAgeInput.value = scenario.clientAge; parentAgeInput.value = scenario.parentAge;
                annualPremiumInput.value = scenario.annualPremium; paymentTermInput.value = scenario.paymentTerm;
                annualGuaranteedPayoutInput.value = scenario.annualGuaranteedPayout; policyPeriodInput.value = scenario.policyPeriod;
                interestRateInput.value = scenario.interestRate; maturityValueInput.value = scenario.maturityValue;
                nonGuaranteedValueInput.value = scenario.nonGuaranteedValue; deathPayoutEarlyInput.value = scenario.deathPayoutEarly;
                deathPayoutLateInput.value = scenario.deathPayoutLate; guaranteedPayoutsData = scenario.guaranteedPayoutsData;
                pruLegacyCheckbox.checked = scenario.pruLegacy; pruWaiverCheckbox.checked = scenario.pruWaiver; parentWaiverCheckbox.checked = scenario.parentWaiver;
                calculateAndRender();
                showTemporaryMessage("Scenario loaded!");
            } else {
                 showTemporaryMessage("No saved scenario found.");
            }
        }
        
        function renderClientSummary(annualSaving, savingTerm, totalSaving, coveragePeriod) {
            const clientSummary = [
                { label: 'Yearly Saving', value: formatCurrency(annualSaving) },
                { label: 'Save for (years)', value: savingTerm },
                { label: 'Maturity/Coverage (years)', value: coveragePeriod },
            ];
            clientSummaryEl.innerHTML = clientSummary.map(item => `
                <div class="summary-box">
                    <p class="summary-box-label">${item.label}</p>
                    <p class="summary-box-value">${item.value}</p>
                </div>
            `).join('');
        }


        function renderContributionTimeline() {
            const paymentTerm = parseInt(paymentTermInput.value) || 0;
            const policyPeriod = parseInt(policyPeriodInput.value) || 0;
            const annualPremium = parseFloat(annualPremiumInput.value) || 0;
            contributionTimelineContainer.innerHTML = '';
            if (policyPeriod <= 0) return;

            const saveContainer = document.createElement('div');
            saveContainer.className = 'timeline-section';
            const receiveContainer = document.createElement('div');
            receiveContainer.className = 'timeline-section';
            const axisWrapper = document.createElement('div');
            axisWrapper.className = 'timeline-axis-wrapper';
            axisWrapper.innerHTML = '<div class="timeline-axis"></div>';
            const yearsContainer = document.createElement('div');
            yearsContainer.className = 'timeline-years';
            
            const maturityFlag = document.createElement('div');
            maturityFlag.className = 'timeline-maturity-flag';
            maturityFlag.textContent = 'Maturity';


            for (let i = 1; i <= policyPeriod; i++) {
                const yearEl = document.createElement('div');
                yearEl.className = 'timeline-year';
                yearEl.textContent = `Y${i}`;
                if(i === policyPeriod) {
                    yearEl.appendChild(maturityFlag);
                }
                yearsContainer.appendChild(yearEl);
            }

            if (paymentTerm > 0 && annualPremium > 0) {
                const saveBar = document.createElement('div');
                saveBar.className = 'timeline-bar';
                saveBar.style.width = `calc(${(paymentTerm / policyPeriod) * 100}% - 4px)`;
                saveBar.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2 flex-shrink-0"><path d="M10 5.5c-1.3 1.4-1.3 3.6 0 5"/><path d="M16.5 10.5c0-3-2.5-5.5-5.5-5.5s-5.5 2.5-5.5 5.5c0 2.2 1.3 4 3 4.8V19c0 1.1.9 2 2 2h2a2 2 0 0 0 2-2v-3.7c1.7-.8 3-2.6 3-4.8Z"/><path d="M2 12c0-3.3 2.7-6 6-6"/><path d="M22 12c0-3.3-2.7-6-6-6"/></svg><span>You Save: <strong>${formatCurrency(annualPremium)}/yr</strong></span>`;
                saveContainer.appendChild(saveBar);
            }

            if (guaranteedPayoutsData.length > 0) {
                let currentBlock = { amount: guaranteedPayoutsData[0], start: 1, end: 1 };
                for (let i = 1; i < policyPeriod; i++) {
                    if (guaranteedPayoutsData[i] === currentBlock.amount) {
                        currentBlock.end = i + 1;
                    } else {
                        createReceiveBar(currentBlock, policyPeriod, receiveContainer);
                        currentBlock = { amount: guaranteedPayoutsData[i], start: i + 1, end: i + 1 };
                    }
                }
                createReceiveBar(currentBlock, policyPeriod, receiveContainer);
            }
            
            contributionTimelineContainer.appendChild(saveContainer);
            contributionTimelineContainer.appendChild(axisWrapper);
            contributionTimelineContainer.appendChild(receiveContainer);
            axisWrapper.appendChild(yearsContainer);
        }

        function createReceiveBar(block, policyPeriod, container) {
            if (block.amount <= 0) return;
            const receiveBar = document.createElement('div');
            receiveBar.className = 'timeline-bar receive-bar';
            const width = `calc(${((block.end - block.start + 1) / policyPeriod) * 100}% - 4px)`;
            const left = `${((block.start - 1) / policyPeriod) * 100}%`;
            receiveBar.style.width = width;
            receiveBar.style.left = left;
            receiveBar.style.marginRight = '4px';
            receiveBar.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2 flex-shrink-0"><path d="m15 9-6 6"/><path d="M10.5 20.5 3 13"/><path d="M13.5 3.5 21 11"/><path d="M17.5 13.5 19 12l1.5 1.5"/><path d="M12 21.5V16l-2.5 2.5"/><path d="m10.5 3.5-2 2.5 2 2.5"/><path d="M3.5 10.5 5 12l-1.5 1.5"/><path d="M20.5 10.5 18 13l-2-2.5 2-2.5"/></svg><span>Receive: <strong>${formatCurrency(block.amount)}/yr</strong></span>`;
            container.appendChild(receiveBar);
        }
        
        function renderTable(rows) {
            savingsTableBody.innerHTML = '';
            const interestRate = parseFloat(interestRateInput.value) / 100 || 0;
            const interestRateHeader = document.getElementById('interestRateHeader');
            interestRateHeader.textContent = (interestRate * 100).toFixed(1);
            if (rows && rows.length > 0) {
                 rows.forEach((row, index) => {
                     const tr = document.createElement('tr');
                     tr.className = `border-b border-slate-200 table-row-hover ${index % 2 === 1 ? 'bg-gray-50' : ''}`;
                     const premiumCellContent = row.premiumPaidThisYear > 0 ? formatCurrency(row.premiumPaidThisYear) : '-';
                     tr.innerHTML = `<td class="p-3 text-center w-1/12">${row.year}</td><td class="p-3 text-right w-3/12">${premiumCellContent}</td><td class="p-3 text-right w-4/12">${formatCurrency(row.annualPayout || 0)}</td><td class="p-3 text-right w-4/12">${formatCurrency(row.total || 0)}</td>`;
                     tr.addEventListener('click', () => openEditModal(row.year));
                     tr.addEventListener('mouseover', () => highlightChartPoint(index));
                     tr.addEventListener('mouseout', () => highlightChartPoint(-1));
                     savingsTableBody.appendChild(tr);
                 });
            } else {
                 savingsTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-slate-500">Please enter values and click "Calculate" to see the table.</td></tr>';
            }
        }
        
        function highlightChartPoint(index) {
            if (lineChartInstance) {
                let activeElements = [];
                if (index !== -1) {
                    activeElements = [ { datasetIndex: 0, index: index }, { datasetIndex: 1, index: index }, { datasetIndex: 2, index: index }, { datasetIndex: 3, index: index }, ];
                }
                lineChartInstance.setActiveElements(activeElements);
                lineChartInstance.update();
            }
        }

        function renderSummary(totalPremiums, guaranteedPayout, projectedPayout, accumulatedPayout, maturity, nonGuaranteed, paymentTerm, goal, clientAge) {
            const totalGrowth = projectedPayout - totalPremiums;
            const growthPercentage = totalPremiums > 0 ? (totalGrowth / totalPremiums) * 100 : 0;
            totalAccumulatedGuaranteedPayoutEl.textContent = formatCurrency(accumulatedPayout);
            guaranteedMaturityEl.textContent = formatCurrency(maturity);
            cashValueEl.textContent = formatCurrency(nonGuaranteed);
            totalProjectedPayoutEl.textContent = formatCurrency(projectedPayout);
            totalPremiumsEl.textContent = formatCurrency(totalPremiums);
            totalPremiumsLabel.textContent = `Total Savings (${paymentTerm} years)`;
            totalGrowthEl.innerHTML = `${formatCurrency(totalGrowth)} <span class="text-xl">(${growthPercentage.toFixed(1)}%)</span>`;
            const clientName = clientNameInput.value.trim();
            const clientNameText = clientName ? clientName + "'s" : "Your";
            const policyPeriod = parseInt(policyPeriodInput.value) || 0;
            let goalText = '', goalTitle = '';
            goalTitle = `Fund Goal:`; 
            goalText = `Reaching ${formatCurrency(projectedPayout)} by Age ${clientAge + policyPeriod}`;
            goalStatementEl.innerHTML = `<p class="text-sm font-medium text-slate-600 mb-1">${clientNameText} ${goalTitle}</p><p class="text-2xl font-bold text-slate-800">${goalText}</p>`;
        }
        
        function renderLineChart(growthData) {
            if (lineChartInstance) { lineChartInstance.destroy(); }
            const allValues = [ ...growthData.guaranteedPayoutValues, ...growthData.projectedPayoutValues, ...growthData.totalPremiumValues, ...growthData.protectionValues ];
            const maxVal = Math.max(...allValues);
            const suggestedMax = maxVal * 1.15;
            const projectedLabelData = Array(growthData.projectedPayoutValues.length).fill(null);
            if (growthData.projectedPayoutValues.length > 0) {
                projectedLabelData[growthData.projectedPayoutValues.length - 1] = growthData.projectedPayoutValues[growthData.projectedPayoutValues.length - 1];
            }
            const data = {
                labels: growthData.labels,
                datasets: [
                    { label: 'Total Guaranteed Payout', data: growthData.guaranteedPayoutValues, borderColor: '#2563eb', backgroundColor: '#2563eb', fill: false, tension: 0.1, pointRadius: 3, pointBackgroundColor: '#2563eb', order: 0, yAxisID: 'y' },
                    { label: 'Total Projected Payout', data: growthData.projectedPayoutValues, borderColor: '#16a34a', backgroundColor: '#16a34a', fill: false, tension: 0.1, pointRadius: 3, pointBackgroundColor: '#16a34a', order: 1, yAxisID: 'y' },
                    { label: 'Total Savings', data: growthData.totalPremiumValues, borderColor: '#a0aec0', backgroundColor: '#a0aec0', fill: false, borderDash: [5, 5], tension: 0.1, pointRadius: 3, pointBackgroundColor: '#a0aec0', order: 2, yAxisID: 'y' },
                    { label: 'Protection Payout', data: growthData.protectionValues, borderColor: '#f43f5e', backgroundColor: '#f43f5e', fill: false, stepped: true, order: 3, yAxisID: 'y' },
                    { label: 'Final Payout', data: projectedLabelData, borderColor: 'transparent', backgroundColor: 'transparent', pointRadius: 0, fill: false, showLine: false, datalabels: { color: '#16a34a', font: { weight: 'bold', size: 14 }, formatter: (value) => formatCurrency(value) }}
                ]
            };
            lineChartInstance = new Chart(growthChartCanvas, { type: 'line', data: data, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, layout: { padding: { right: 50 }}, plugins: { legend: { position: 'bottom', labels: { color: '#334155', boxWidth: 12, padding: 20 }}, tooltip: { callbacks: { label: (context) => { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += formatCurrency(context.parsed.y); } return label; }, afterBody: (context) => `Annual Payout: ${formatCurrency(growthData.annualPayoutValues[context[0].dataIndex])}` }}, datalabels: { align: 'end', anchor: 'end', offset: 8, backgroundColor: 'rgba(255, 255, 255, 0.8)', borderRadius: 4, padding: 6, color: '#1e293b', font: { weight: 'bold' }, formatter: (value, context) => { const data = context.dataset.data; if (!data || data.length === 0) return null; const isFinalPoint = context.dataIndex === context.dataset.data.length - 1; const isProjectedOrGuaranteed = context.dataset.label === 'Total Projected Payout' || context.dataset.label === 'Total Guaranteed Payout'; if (isProjectedOrGuaranteed && isFinalPoint) { return formatCurrency(value); } if (context.dataset.label === 'Total Savings') { const max_value = Math.max(...data); const first_max_index = data.indexOf(max_value); if (context.dataIndex === first_max_index) { return formatCurrency(value); } } return null; }}}, scales: { y: { type: 'linear', display: true, position: 'left', beginAtZero: true, ticks: { color: '#475569', callback: value => formatCurrency(value) }, grid: { color: '#e2e8f0' }, suggestedMax: suggestedMax }, x: { ticks: { color: '#475569' }, grid: { display: false }}}}});
        }

        function switchTab(tab) {
            tabTableBtn.classList.remove('active'); tabChartBtn.classList.remove('active');
            tableContent.classList.add('hidden'); chartContent.classList.add('hidden');
            if (tab === 'chart') { tabChartBtn.classList.add('active'); chartContent.classList.remove('hidden'); }
            else if (tab === 'table') { tabTableBtn.classList.add('active'); tableContent.classList.remove('hidden'); }
        }

        function openEditModal(year) {
            currentlyEditingYear = year;
            modalTitle.textContent = `Edit Year ${year} Guaranteed Payout`;
            modalSavingsInput.value = guaranteedPayoutsData[year - 1];
            applyToFollowingCheckbox.checked = false;
            editModal.classList.remove('hidden');
        }

        function closeModal() {
            editModal.classList.add('hidden');
            currentlyEditingYear = -1;
        }

        function saveChanges() {
            const newGuaranteedPayout = parseFloat(modalSavingsInput.value);
            if (isNaN(newGuaranteedPayout) || currentlyEditingYear === -1) return;
            const yearIndex = currentlyEditingYear - 1;
            guaranteedPayoutsData[yearIndex] = newGuaranteedPayout;
            if (applyToFollowingCheckbox.checked) {
                for (let i = yearIndex + 1; i < policyPeriod; i++) {
                    guaranteedPayoutsData[i] = newGuaranteedPayout;
                }
            }
            calculateAndRender();
            closeModal();
        }
        
        function showTemporaryMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.textContent = message;
            messageBox.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg bg-blue-600 text-white z-50 transition-all duration-300 ease-in-out transform scale-100';
            document.body.appendChild(messageBox);
            setTimeout(() => {
                messageBox.classList.add('scale-0');
                messageBox.addEventListener('transitionend', () => messageBox.remove());
            }, 3000);
        }

        function formatCurrency(amount) {
            return 'RM ' + new Intl.NumberFormat('en-MY', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
    </script>
</body>
</html>

